# This tutorial was developed by Jon Shurin for use with R studio, 
# It is based on data collected by Emily Adamzcyk for her MS thesis at UCSD.  It should not be shared or used for other purposes

#setwd('~/Desktop')  ##MAC
setwd('C:/Users/jshur/OneDrive/Desktop/BIEB 135 2021')  #FOR PCs

# note, if you want to use R on your PC you'd use this syntax instead, note that your PC defaults to "\" but R needs "/":
# The part inside the apostrophes is the directory extension of the folder where you will save your data and code

# Load your packages per usual

library(lattice)
library(Hmisc)
library(ggplot2)
library(sciplot)
library(reshape2)
library (doBy)
library (car)
install.packages(c("maps", "mapdata"))
library(maps)
library(mapdata)
library(vegan)

rm(list=ls())

f<-read.csv("fish eggs CALCOFI.csv")

# First, R thinks latitude and longitude are characters (words) not numbers, let's fix that

f$latitude<-as.numeric(f$latitude); f$longitude<-as.numeric(f$longitude)

# First, let's look at what species are present

levels(as.factor(f$common_name))

# So there are seven species, and one of them is "unidentified".  Next let's see how many cruises there were

levels(as.factor(f$cruise))

# There were cruises in February, April, July and November of 2014

# There are 2 columns for egg numbers "egg_count" which is the number counted under the microscope and "eggs_10m2" which is the density of eggs accounting for
# the volume of the sample and the fraction that was counted.  Sometimes when there are lots of eggs you only count a fraction of the sample.  

#  We'll make a data table called "SpAvg" that's the average egg density per species.  

SpAvg<-summaryBy(eggs_10m2 ~ common_name, data=f, FUN=mean)

# now sort it so teh bars go in the right order

SpAvg<-orderBy(~-eggs_10m2.mean, data=SpAvg)

barplot(SpAvg$eggs_10m2.mean, names.arg = SpAvg$common_name)

# The most common species is "Unidentified" followed by Northern Anchovy, Jack Mackerel, Pacific Mackerel, sardine, hake and saury.  This tells you that most 
# fish eggs are small round balls that can't be told apart by species.  If you want to get fancy you can use genetics to tell them apart.  This category likely
# includes a LOT of species, maybe dozens or hundreds, that all make very similar looking eggs. 

# Next let's make a map of the sites by plotting latitude against longitude

plot(latitude~longitude, data=f)

# you can see the shape of the California coast.  If you look at the data set you see there are not many samples north of Latitude 40, so let's throw out those
# samples to make our plots look better

f<-subset(f, latitude<35)
  
# to visualize the abundance of species among sites, let's start by taking out just the Feb 2014 data

F14<-subset(f, cruise=="201402")

# We'll plot latitude against longitude to make a map of the sampling stations and make the size of the point proportional to the number of fish eggs of 
# each species.  First, we can see that fish egg density varies ALOT.  Here's a frequency plot of density of fish eggs (#/m2 of ocean)

hist(f$eggs_10m2, breaks=30)

# You can see that the most common value is 0, bu the density goes all the way up to 20,000 / 10 m^2.  With such huge variability, it often makes sense to transform 
# the data so the patterns are easier to see (othewise all you'll see are the huge ones).  We'll use a log base 10 transformation, which doesn't work for the 
# zeros but that's OK because zero just means that species wasn't present in that sample.  So now in "geom_point" we'll set the size  equal to 
# log10(eggs_10m2)

ggplot(F14, aes(longitude, latitude)) +
  geom_point(aes(size = log10(F14$eggs_10m2), colour = factor(common_name)))  +
  facet_grid(vars(common_name), scales = "free")

# Now the point size is proportional to the log of density.  So a point with a value of 1 means 10/10m^2, 2 means 100/10m^2, and 3 means 1000/10m^2.  You can see 
# that unidenitified eggs are everywhere, the other species are mostly concentrated near shore except for one offshore sample that was full of jack mackerel.  

# Now let's see what other cruise values there are for the other cruises.  Now we'll make the same plots but one set for each of the 4 cruises.  We do this by 
# setting the "cols" to "vars(cruise)" in the "facet_grid" line


ggplot(f, aes(longitude, latitude)) +
  geom_point(aes(size = log10(eggs_10m2), colour = factor(common_name)))  +
  facet_grid(rows=vars(common_name), cols=vars(cruise), scales = "free")


# Here you can see the seasonal and spatial patterns of different species.  What do they look like?  Are some species more concentration near shore vs. offshore,
# and do some reproduce at certain times of year more than others?  

# Let's see how total number of fish eggs of all species changes among stations and with time.

TotAbun<-summaryBy(eggs_10m2 ~ cruise + line + station, data=f, FUN=sum)
names(TotAbun)[4]<-"TotAbun"

# Now we merge the total abundance back into the main data set (f)

f<-merge(f, TotAbun, by=c("cruise","line","station"), all=T)

# Now we make a map of total fish egg abundance

ggplot(f, aes(longitude, latitude)) +
  geom_point(aes(size = TotAbun))  +
  facet_grid(cols=vars(cruise), scales = "free")

# Now let's calculate fish egg diversity to see how it changes in space and time.  First, there are a lot of columns in our data table that are not that useful
# to us, so let's get rid of them, and make a new table called "f2"

f2<-f[,-c(2:11,14:17,19,20)]

# Now we've got only 5 columns to work with.  Let's put the species into columns to calculate diversity:

f3<- dcast(f2, cruise+latitude+longitude~common_name, sum) 

# Now we have a table with cruise, latitude, longitude and the densities of eggs of each species in the colunms.  Let's calculate richness and diversity

f3$richness<-specnumber(f3[,c(4:10)])
f3$Shannon<-diversity(f3[,c(4:10)], index = "shannon")

# Now let's "melt" it back down to long format so we can use the diversity measure (richness vs. diversity) to make the plot

div<-melt(f3[,c(1:3,11,12)], id=c(1:3))
names(div)[4]<-"div"

# Now we can make maps of richness and diversity


ggplot(div, aes(longitude, latitude)) +
  geom_point(aes(size = value, colour = factor(div)))  +
  facet_grid(rows=vars(div), cols=vars(cruise), scales = "free")



# Questions to answer:

#  1.  How do diversity and species richness of marine fish eggs and lake zooplankton compare?  
#  2.  How does chlorophyll concentration vary within and among lakes?  
#  3.  Why do you think chlorophyll shows these patterns?  
#  4.  Are fish diversity and species richness higher near shore or offshore in the California Current?
#  5.  How are fish egg diversity and abundance related to chlorophyll concentration in the California Current?    
  



### OLD STUFF Cleaning up the data

california <- map_data("state") %>% 
  filter(region == "california")

# We will use 2 data sets.  One is microscope counts of different zoopalntkon taxa ("Lake Zooplankton.csv") from 3 reservoirs on different dates.  

rm(list=ls())


f<-read.csv("CALCOFI fish eggs.csv")

f$eggs_10m2<-as.numeric(f$eggs_10m2)
f$eggs_1000m3<-as.numeric(f$eggs_1000m3)
f<-f[,-c(4,20,24)]
f2<-na.omit(f)

# First let's look at the abundance of species across the data set.  We'll calculate the average abundance of each species in each sample

AvEggs<-summaryBy(eggs_10m2 ~ common_name, data=f2, FUN=mean)
MaxEggs<-summaryBy(eggs_10m2 ~ common_name, data=f2, FUN=max)
ME<-subset(MaxEggs, eggs_10m2.max>0)

# This is the base data set
f3<-f2[f2$common_name %in% ME$common_name,]

write.csv(f3, file="fish eggs CALCOFI.csv", row.names=FALSE)
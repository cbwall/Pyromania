# This tutorial was developed by Jon Shurin for use with R studio, 
# It is based on data collected by Emily Adamzcyk for her MS thesis at UCSD.  It should not be shared or used for other purposes

#setwd('~/Desktop')  ##MAC
setwd('C:/Users/jshur/OneDrive/Desktop/BIEB 135 2021')  #FOR PCs

# note, if you want to use R on your PC you'd use this syntax instead, note that your PC defaults to "\" but R needs "/":
# The part inside the apostrophes is the directory extension of the folder where you will save your data and code

# Load your packages per usual

library(lattice)
library(Hmisc)
library(ggplot2)
library(sciplot)
library(reshape)
library (doBy)
library (car)

# We will use 2 data sets.  One is microscope counts of different zoopalntkon taxa ("Lake Zooplankton.csv") from 3 reservoirs on different dates.  

rm(list=ls())


z<-read.csv("Lake Zooplankton.csv")
z$Lake<-as.factor(z$Lake) # Making Lake a factor
z$Date<-as.Date(z$Date) # Making Date a date


# #This file shows the densities in # per liter, from microscope counts, of 14 different groups of zooplankton taxa.  Each row is a sample from an individual 
# date when a net tow was taken from the middle of each lake.  The columns indicate the lake, date, Julian date, day number, and the densities of different
# taxa identified and counted under the microscope.  Some of these are species of Daphnia, others are groups of species or life history stages of copepods like 
# "Adult Calanoids" or "Nauplii" (baby copepods).  This is because copepods are hard to tell apart when they're  babies and become more distinct as they grow
# bigger.  Our first goal is to look at how the groups change over time in each lake

ggplot(z, aes(x = Date, y = Daphnia.pulex)) +
   geom_line(aes(color = Lake), size = 1) +
   scale_color_manual(values = c(2,3,4)) +
   theme_minimal()

# It looks like Daphnia pulex is most abundant in Poway, less in iramar and rarest in Murray, except that it suddenly became abundant in Murray at the end of 
# the survey.  Now let's make similar plots for all the species.  To do that we have to "melt" the data frame or rearrange it so that, rather than one column
# for each species, we have a column called "species" for the species name, and another called "abundance" for the count (#/L).  we use the "melt" function
# in reshape, keeping the Lake, Date, jdate and day columns constant and putting all the others (the species) into one column.  We'll make a new data frame 
# called z2 since we'll need to save the original format for later analyses

z2<- melt(z, id = c("Lake","Date","Jdate","day")) 

#now we'll rename the last two columns as "species" and "density"
names(z2)[5]<-"Species"
names(z2)[6]<-"Density"

ggplot(z2, aes(x = Date, y = Density)) +
  geom_line(aes(color = Lake), size = 1) +
  scale_color_manual(values = c(2,3,4)) +
  theme_minimal()+
  facet_grid(vars(Species), scales = "free")

# That let's you see what each species is doing in each lake, but it's a bit difficult to make sense of it.  Let's try looking at the data a different way
# by making stacked bar charts where the color indicates the species so we get all the species in a single bar.  We'll start with relative abundance, where
# he height of the bar is 1.00 and the length of the color indicates what % of the total individuals belong to each species.  This lets us see rare species 
# better, but obscures differences in total abundance of zooplankon. 

# First, let's plot just Lake Murray using the "subset" function in ggplot 2
ggplot(subset(z2, Lake %in% c("Murray")),aes(fill=Species, y=Density, x=Date)) +
  geom_bar(stat="identity", position="fill", width=4)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x = "Date") 

# You can see that nauplii (baby copepodsa) are most abundant early on but become less so with time, and that juvenile cyclopoids and calanoids become more 
# numerous.  This represents nauplii maturing into later life stages
# You can also see that Daphnia pulexis rareat first and Bosmina is common
# but Daphnia pulex becomes more common around March 2014 and Bosmina declines.

#Now let's plot all 3 lakes
ggplot(z2,aes(fill=Species, y=Density, x=Date)) +
  geom_bar(stat="identity", position="fill", width=4.5)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x = "Date") +
  facet_grid(vars(Lake))


# What patterns of composition can you see among the lakes? How are the lakes similar
# in the abundance of species and how are they different?  
  
# These graphs show the relative abundance of each taxa as a percent of the total zooplantkon count, not the absolute abundance. This makes it easier to see
# rare species since a few dominant taxa make up the large majority of the individuals.  To plot absolute abundance (#/L), we make the same graphs but remove 
# ", position="fill") from the geom_bar line
ggplot(z2,aes(fill=Species, y=Density, x=Date)) +
  geom_bar(stat="identity", width=4.5)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x = "Date") +
  facet_grid(vars(Lake))
  
# Now the height of the bar indicates the total number of zooplantkon in the sample.  
# How does the abundance of zooplankton differ among the lakes?  
# How do these graphs look different from relative abundance?  

# Next we would like to compare zooplankton diversity among the 3 lakes and over time.  To do this we'll go back to the original arrangement of the data with
# species in columns (dataframe "z") and calculate two kinds of diversity.  To do this we need a new library called "vegan" (don't ask why).  You will probably
# need to install the package first.  

library(vegan)
    
# First we need to combine adult and juvenile calanoids and copepod since these likely belong to the same species.  We'll make new variables called "Calanoids all"
# and "Cyclopoids all".  

z$All.Calanoid<-z$Adult.Calanoid+z$Juv..Calanoid
z$All.Cyclopoid<-z$Adult.Cyclopoid+z$Juv..Cyclopoid

# Then we'll remove nauplii and the adult and juvenile categories, and make a new data frame called z3

z3<-z[,-c(5,8:11)]

# We'll calculate two kinds of diversity, the Shannon index and species richness.  Richness is the number of taxa identified in a sample with density > 0, 
# while Shannon is based on the inverse of the probability that two individuals in a sample belong to the same species.  If we have many species of similar 
# abundances, then the probability that any two individuals belong to the same species is low and Shannon's is high.  We make a new column for each diversity
# measure, one called "richness" and the other called "Shannon"

z3$richness<-specnumber(z3[,c(5:15)])
z3$Shannon<-diversity(z3[,c(5:15)], index = "shannon")

# Now we make a new dataset with only time and the two diversity measures, and put it in long format ("melt") to make the graph more easily

div<-melt(z3[,c(1:4,16,17)], id=c(1:4))

# Now we plot the two 


ggplot(div, aes(x = Date, y = value)) +
  geom_line(aes(color = Lake), size = 1) +
  theme_minimal()+
  facet_grid(vars(variable), scales = "free")

# How would you describe these patterns of diversity?  How are the lakes different or similar in diveristy or richness, and how do these change throughout the 
# year?  How do these patterns relate to the abundance patterns shown in the graphs above?  

# Next we're going to look at how the patterns of abundance of phytoplankton, bacteria and zooplankton change throughout the year.  To turn microscope counts
# into zooplankton biomass, we measured the average body size of each species, calculated the weight of the average individual, added up all the individuals
# in the population, and added up the weights of all the populations in the lake.  

# How are abundance and diversity related in zooplankton?  

ld<-read.csv("LakeData2.csv")
names(ld)
ld<-orderBy(~Date + Lake, data=ld)  # Sorts the data frame in order of station, month and depth
ld$Date<-as.Date(ld$Date)

# Here the first 4 variables are the same as before, the next are water and air temperature, wind speed, pH, conductivity, Alkalinity, chlorophyll concentration,
# salinity, partial pressure of CO2, counts of bacteria and chytrid fungi, total nitrogen, phosphorus and carbon, and zooplankton community bioamss.  

ggplot(ld, aes(x = Date, y = Chla)) +
  geom_line(aes(color = Lake), size = 1) +
  scale_color_manual(values = c(2,3,4)) +
  theme_minimal()

#Hmm, what happened to chlorophyll in Murray?  Think back to the Daphnia pulex graph we made on Line 36.  

# Now make similar plots for the abundance of bacteria, chytrid fungi, and zooplankton biomass.  

# Finally, we can plot abundance of different groups against each other and see if and how they're correlated.  


pairs(log(ld[,c(11,14:17,19)]))

group <- NA
group[ld$Lake == "Miramar"] <- 1
group[ld$Lake == "Murray"] <- 2
group[ld$Lake == "Poway"] <- 3

pairs(log(ld[,c(11,14:17,19)]), col = c("red", "cornflowerblue", "purple")[group],   # Change color by group
      pch = c(16, 17, 18)[group])



# Questions to answer:

# 1.  What do seasonal patterns of abundance look like for bacteria, fungi, phytoplankton and zooplantkon abundance?  How are they similar or different?
# 2.  How are abundance of these groups related to each other (positively, negatively or not at all)?  What does this tell you about how they interact?  
# 3.  How are seasonal patterns of abundance, diversity and productivity similar or different among the lakes?  What do these say about top-down and bottom-up
#     control?  



### Getting data

z<-read.csv("Lake Zooplankton.csv")

names(z)
z<-z[,-c(18,19,22)]
z<-z[with(z, order(Lake, Jdate)), ]
z$year<-as.numeric(substr(z$Jdate, 1,2))-13
z$dayno<-as.numeric(substr(z$Jdate,3,5))
z$day<-z$dayno+365*z$year


names(z)

#CALCULATE NUMBER PER sample
z[,c(23:36)]<-z[,c(6:19)]*z$Split
z[,c(37:50)]<-z[,c(23:36)]/((pi*0.3^2)*z$Depth*1000) #calculate number per liter, volume
z<-z[,c(1:3,22,37:50)]

names(z)<-gsub('.1.1', '', names(z))

levels(as.factor(z$Date))
#z$Date[z$Date=="2013-08-19"]<-"2013-08-21"


write.csv(z, file = "Lake zooplankton.csv",row.names=FALSE)

# This tutorial was developed by Jon Shurin for use with R studio, 
# some of the introduction was originally written by Daniel Bunker, Columbia University
# Designed for BIEB 135 to be run on PCs, but see notes for Mac users in the annotation

# Every time you start a new R script, you should set your working directory and load any packages you'll need
# Note that you should also put any files you need in this working directory, otherwise the code below won't work
# Use getwd() to find out the current directory, and setwd() to change it. Practice running this line below:

#setwd('~/Desktop')  ##MAC
setwd('C:/Users/jshur/OneDrive/Desktop/BIEB 135 2021')  #FOR PCs

# note, if you want to use R on your PC you'd use this syntax instead, note that your PC defaults to "\" but R needs "/":
# The part inside the apostrophes is the directory extension of the folder where you will save your data and code

# In R Studio, you will see a window with a "Packages" tab in the lower right, you can click the boxes to load
# packages that are already installed.  You can also just run the code below to load a package to your library.
# To install a new package click "Install Package" and enter the name of the package you want to load, 
# you will only need to *install* a package one time this quarter, but will need to *load them into the library*
# every time you open R. Here are some common ones, you will need them for the tutorial, go ahead and install & then load them now:

library(lattice)
library(Hmisc)
library(ggplot2)
library(sciplot)
library(reshape)
library (doBy)
library (car)

# Note! Often, if a particular package was built under a different version of R you'll get red text in the 
# console below. Don't worry about it! You can check if a package loaded from the library by clicking on the
# "Packages" tab in the window on the bottom right. If a package has a checkmark next to it, it's been loaded.

# In the Week 2 module on Canvas you'll find a dataset called "Vertical profiles.csv"
# Download it and save it to the desktop. Then run the following line of code to load the data:

#elliott<- read.csv('~/Desktop/Elliott_worksheet.csv', header=TRUE, check.name=FALSE)
vert<- read.csv('Vertical profiles.csv', header=TRUE, check.name=FALSE)

# to start, we'll make just one vertical profile for one date, 11-Sep-2013

# note that the code you last ran will appear blue in the console below, and it will display a ">"
# which means that the code worked and R is ready for the next command.

# A new dataset should have appeared in the upper right window, including the number of rows (obs) and columns (variables)
# click on it once and it will open as a spreadsheet and you can look at it. Each row represents a measurment
# from a specific lake at a certain depth on a given date.  The three lakes are Miramar, Murray and Poway, 3 San 
# Diego reservoirs.  The variables measured are depth (m), temperature (deg C), pressure (mg Hg), dissolved oxygen 
# (DO, % of saturation), dissolved oxygen (mg/L), conductivity (uS/cm), salinity (ppt), pH, and sampling date number.
# jdate is the Julian date, e.g., 13254 means the 254th day of 2013.  

# Now lets start to look at how things vary with depth.  The plot we want to make has depth on the y-axis and
# chemical variable on the x.  Normally we would think of depth as the "independent" variable and put it on the x,
# BUT because depth goes up and down we'll put it on the y, and also have it go fronm the surface down because that's
# how lakes are.  First we'll make a file for each lake to simplify things:

Murray<-subset(vert, lake=="Murray")

plot(Murray$depth ~ Murray$temp_c, subset=Murray$jdate==13254, type="b", xlab="Temperature (deg C)", ylab="depth (m)")

# here the water is a balmy 27 deg at the surface, starts getting cold around 8-9m depth, and is around 16 at the 
# bottom (15m).  This is OK but looks a little funny because the surface of the lake is at the bottom of the graph
# so let's reverse the y-axis using the ylim (y limits) function

plot(Murray$depth ~ Murray$temp_c, subset=Murray$jdate==13254, type="b", xlab="Temperature (deg C)", 
     ylab="depth (m)", ylim=c(18,0))

# that's more like it!  Give ourselves a pat on the back, but not too many because that's only one date!  What do 
# all the dates look like?  How does vertical stratification change throughout the year?  Here's some code to plot
# temperature by depth making a separate line for each date.  

ggplot(Murray, aes(y = depth_m,
           x = temp_c,
           col = date)) +
  geom_path() +
  scale_y_reverse()

# hmmm... well that's a bit of a dog's breakfast.  First of all, that poor student sure did a lot of sampling!  How
# many dates were there?  Let's see them all:

levels(as.factor(Murray$date))

# She sampled 37 times!
# Second you can see that Lake Murray is stratified sometimes and not others.  The bottom of the lake around 15m is 
# always cold (around 14-18 deg) while the surface ranges from 15-27.  That's the lake becoming stratified and mixing!
# When the top and the bottom are the same temperature, the lake is mixed.  when the top is warmer, it is stratified.

# How can we visualize how the stratification proceeds throughout the year?  One way is to make a heat map with 
# date on the x-axis, depth on the y, and the color corresponding to temperature

Mur <- ggplot(Murray, aes(date, depth_m)) +                           # Create heatmap with ggplot2
  geom_tile(aes(fill = temp_c))+
  scale_y_reverse()+
  theme(axis.text.x = element_text(angle=45, hjust = 1))

Mur

#Here each colored square is a measurement on a particular date.  You can see that the person doing the study sampled a lot of depths 
# early in the study and got sick of it, started sampling just 5 later on, sometimes sampled only 2.
# The graph looks OK but let's make warm temperatures red and cold ones blue

Mur+ scale_fill_gradient(low = "blue", high = "red") 

# here each colored bar indicates a temperature reading.  You can see that the surface temperatures start out warm
# and get cold around sampling dates # 25-30, and start to warm up again after that.  THere's also a lot of variation 
# in which depths get sampled, early on it was every meter and later it was only at 1, 5, 9, 13 and 16m, so let's 
# just look at those dates to make it simpler.  The vertical line operator "|" means "or", so this code makes a 
# new data table with one of those five depths.  

Murray2<-subset(Murray, depth_m==1|depth_m==5|depth_m==9|depth_m==13|depth_m==16)

Mur2 <- ggplot(Murray2, aes(date, depth_m)) +                           
  geom_tile(aes(fill = temp_c))+
  scale_y_reverse()+ 
  scale_fill_gradient(low = "blue", high = "red")+ 
  theme(axis.text.x = element_text(angle=45, hjust = 1))


Mur2

#Now let's see what the annual cycle looks like in all the lakes using "facet_wrap" to make 3 panels, one for each lake

all <- ggplot(vert, aes(date, depth_m)) +                           
  geom_tile(aes(fill = temp_c))+
  scale_y_reverse()+ 
  scale_fill_gradient(low = "blue", high = "red") +
  facet_wrap(~lake
           , nrow = 1
           , scales = "free_x")+
  theme(axis.text.x = element_text(angle=45, hjust = 1))

all

# You can see that the warm water extends deeper into the water column in lakes Miramar and Poway than in Murray.

# Now let's check out Dissolved Oxygen

DO <- ggplot(vert, aes(date, depth_m)) +                           
  geom_tile(aes(fill = do_mg_l))+
  scale_y_reverse()+ 
  scale_fill_gradient(low = "blue", high = "red")+
  facet_wrap(~lake
             , nrow = 1
             , scales = "free_x")+  
  theme(axis.text.x = element_text(angle=45, hjust = 1))
DO

# Hmm, looks like the surface waters of all lakes are well oxygenated all year round (DO ~ 9mg/L) but the bottoms of Murray and 
# Miramar can go hypoxic (DO < 4mg/L) at various times, Miramar during the warmer periods and Murray all year.  Poway is well 
# oxygenated all year.  Fish and invertebrates like clams can start to gasp for breath below around 4 mg O2/L.  
# The gray areas are where there are NAs in the data set, we have temperature data but not DO, presumably the probe was having a problem.  

DO_perc <- ggplot(vert, aes(date, depth_m)) +                           
  geom_tile(aes(fill = do_percent_l))+
  scale_y_reverse()+ 
  scale_fill_gradient(low = "blue", high = "red")+
  facet_wrap(~lake
             , nrow = 1
             , scales = "free_x")+  
  theme(axis.text.x = element_text(angle=45, hjust = 1))

DO_perc

#  the % saturation ranges from >100% to <50

# Now make the graph for pH

#
#Questions for exercise
#  1.  What does the seasonal cycle of thermal stratification look like in the three lakes?  How is it similar and 
# how is it different?
#  2.  What does the seasonal cycle of oxygen concentration look like in the three lakes?  How is it similar and 
# how is it different?  Is oxygen supersaturated or undersaturated?  Why?  
#  3.  How does pH vary with depth and throughout the year?  Do you think pH and oxygen are related?  Why?  What 
# biological and physical factors affect each?  


---
title: "Cody"
author: "Cody Spiegel"
date: "4/22/2022"
output: word_document
---

```{r setup chunk, setup, include = FALSE, cache=FALSE, message=FALSE, warning=FALSE}
if (!require('knitr')) install.packages('knitr'); library('knitr')
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center')

# load packages
if (!require("pacman")) install.packages("pacman") # for rapid install if not in library

# use pacman to load all the packages you are missing!
pacman::p_load('knitr', 'lme4', 'lmerTest', 'tidyverse', 'magrittr', 'effects', 'plyr', 'dplyr', 
               'plotrix', 'car',"gridExtra", "cowplot", "tools")
Fig.formatting<-(theme_classic()) +
  theme(text=element_text(size=10),
        legend.text.align = 0,
        panel.border = element_rect(fill=NA, colour = "black", size=1),
        aspect.ratio=1, 
        axis.ticks.length=unit(0.25, "cm"),
        axis.text.y=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=10), 
        axis.text.x=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=8)) +
  theme(legend.key.size = unit(0.4, "cm")) +
  theme(aspect.ratio=1.3) +
  theme(panel.spacing=unit(c(0, 0, 0, 0), "cm"))


```

###DOC  
import and do a loop to clean up all files and make stacked data in single df
```{r}
## import treatment IDs
IDs<-read.csv("/Users/tobyspiegel2/Desktop/My_pyromania/Pyromania/data/treatment.IDs.csv")

##### grab files in a list
Total.DOC.files <- list.files(path="/Users/tobyspiegel2/Desktop/My_pyromania/Pyromania/data/DOC.TN", pattern = "csv$", full.names = T)

##### what are the file names, sans extensions using package 'tools'
file.names<-file_path_sans_ext(list.files(path="/Users/tobyspiegel2/Desktop/My_pyromania/Pyromania/data/DOC.TN", pattern = "csv$", full.names = F))

############ formatting all data in for loop
  for(i in 1:length(Total.DOC.files))
    {
  data<-read.csv(Total.DOC.files[i], sep=",")
  data<-data[,c(1,3,4)] # removed columns we don't need
  data$File<-Total.DOC.files[i]
  colnames(data)<-c("Tank", "DOC..mg.L", "TN..mg.L", "File")
  data$Tank<- IDs$Tank
  data$Tank<-as.numeric(as.character(data$Tank)) # make the column of samples all numeric
  data <- data[!is.na(as.numeric(as.character(data$Tank))),] # remove all rows that aren't numeric/tanks
  data$Treatment<-IDs$Treatment
  data$plant.mass..g<-IDs$plant.mass..g
  make.names(assign(paste(file.names[i], sep=""), data)) # make the file name the name of new df for loop df
  }

########## this is the end of the loop

#Combine files from loop to single df
DOC.df<-rbind(DOC_T1, DOC_T2, DOC_T3, DOC_T4)
DOC.df$Treatment=as.factor(DOC.df$Treatment)

DOC.df$File<-substr(DOC.df$File, 64, 74) 
# alternative way to code the above
#give the 10th-24th character of the file name, removing the rest
#DOC.df$File<-substr(DOC.df$File, 13, 27) 

#alternatively
# remove the 9 letters ('^.) at start 
# remove the 4 letters (.$') at end
#DOC.df$File<-gsub('^.........|....$', '', DOC.df$File) 

# if equals DOC_T0_11052021 then, T0, if not then T1
DOC.df$Time.point<- as.factor(
         ifelse (DOC.df$File=="DOC_T1.csv", "T1",
           ifelse (DOC.df$File=="DOC_T2.csv", "T2", 
                   ifelse(DOC.df$File=="DOC_T3.csv", "T3", "T4"))))

#rearrange
library(dplyr)
DOC.df<- DOC.df %>% 
  dplyr::select(File, Time.point, Treatment, Tank, plant.mass..g, DOC..mg.L, TN..mg.L) 

#visualize
ggplot(DOC.df, aes(x = plant.mass..g, y = DOC..mg.L, colour = Treatment)) +
    geom_point() +
    facet_grid(~Time.point)+
    geom_smooth(method = 'loess', se = FALSE) 


```


```{r}
library(mgcv)
library(gratia)
#A single common smoother plus group-level smoothers that have the same wiggliness (model GS)
m1.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, k=8, m=1) + s(plant.mass..g, Time.point, k=8, bs="fs", m=1), data=DOC.df, method="REML")
summary.gam(m1.gam)
draw(m1.gam)
k.check(m1.gam)

```
I think this one is the best fit
```{r}
#first model is that the reference level of mass is modeled as a constant term (it is the intercept), with the effect of mass for the other levels being smooth differences from this constant.
m2.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, by=Treatment, k=8, m=1) + s(plant.mass..g, Time.point, k=11, bs="fs", m=1), data=DOC.df, family= Gamma("log"), method="REML", select = T)
summary(m2.gam)
draw(m2.gam)
k.check(m2.gam)
#intercept adjustment for unburned in comparison with burned in parametric
#the smooth terms summary shows two smooths that are sig different from 0. We cannot conclude from the summary that the two curves are different from each other.
```


```{r}
#in the second model,  add s(mass), which then models the smooth effect of mass in the reference level. Now, the by smooths model smooth differences from this no-longer-constant reference smooth.
#order factors
DOC.df2=data.frame(DOC.df)
DOC.df2=mutate(DOC.df2, oTreatment= ordered(Treatment, levels= c("burned", "unburned")))
DOC.df2$oTreatment=as.factor(DOC.df2$oTreatment)


m2.gamB=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, bs="tp", k=8) + s(plant.mass..g, by=oTreatment, k=8, m=1) + s(plant.mass..g, Time.point, k=11, bs="fs", m=1), data=DOC.df2, method="REML", family= Gamma(link = "log"), select = T)
summary(m2.gamB)
gam.check(m2.gamB, rep=1000)
AIC(m2.gam, m2.gamB)
#intercept adjustment for unburned in comparison with burned in parametric summary
#smooth summary shows smooths that are different from 0: the reference smooth (burned) and the difference smooth (unburned - burned). When the difference smooth is sig different from 0, we can conclude that 2 groups follow a different trend over time
draw(m2.gamB)
#estimated smoooth trend for burned (top left), and difference smooths reflecting estimated differences between the burned and unburned 






# the second model, all the levels of Treatment respond similarly to mass hence there are no large deviations from the smooth for the reference level of Treatment and hence the terms are not significant. the model is set up like ANOVA contrasts (estimate an effect for the reference level then have differences between individual levels and the reference), then fit the model like model 2

#In the first model, the effect of mass for the reference level was constant, so the difference smooths picked up the actual non-linear effect of mass and hence were significantly different from zero
```


```{r}
AIC(m2.gam, m2.gamB)
#gamB seems to be the better fit
gam.check(m2.gamB, rep=1000)
library(visreg)
visreg(m2.gamB, xvar = "plant.mass..g",
       by = "Time.point", data = DOC.df,
       method = "REML", gg=T)


```

```{r}
m3.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, bs="tp", k=13) + s(plant.mass..g, Time.point, by=Treatment, k=8, bs="fs", m=1), family = Gamma(link = "log"), data=DOC.df, method="REML", select = T)
summary(m3.gam)
draw(m3.gam)
plot.gam(m3.gam)
gam.check(m3.gam, rep=1000)

library(visreg)
visreg(m3.gam, xvar = "plant.mass..g",
       by = "Time.point", data = DOC.df,
       method = "REML", gg=T)

AIC(m2.gam, m2.gamB, m3.gam)
```

```{r}
#with link= log
m4.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, bs="tp", k=13) + s(plant.mass..g, Time.point, by=oTreatment, k=8, bs="fs", m=1), family = Gamma(link = "log"), data=DOC.df2, method="REML", select = T)
summary(m4.gam)
draw(m4.gam)
AIC(m2.gam, m2.gamB, m3.gam, m4.gam)
```

```{r}
m5.gam=gam(DOC..mg.L~ Treatment + s(plant.mass..g, bs="cr", k=8, m=1)+ s(plant.mass..g, by=oTreatment, k=8, m=1) + te(plant.mass..g, Time.point, bs=c("cr","re"), k=8, m=1),
           data= DOC.df2,
           methods= 'REML',
           select=TRUE)
summary(m5.gam)
draw(m5.gam)
```


Separate models for each time point
```{r}
DOC_T1$Treatment=as.factor(DOC_T1$Treatment)
m1=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, by= Treatment, k=8, m=1), data= DOC_T1, method= "REML")
summary.gam(m1)
draw(m1)

```
```{r}
DOC_T2$Treatment=as.factor(DOC_T2$Treatment)
m2=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, by= Treatment, k=8, m=1), data= DOC_T2, method= "REML")
summary.gam(m2)
draw(m2)



```

```{r}
DOC_T3$Treatment=as.factor(DOC_T3$Treatment)
m3=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, by= Treatment, k=8, m=1), data= DOC_T3, method= "REML")
summary.gam(m3)
draw(m3)




```

Not sure why T4 is being difficult...
```{r}
DOC_T4$Treatment=as.factor(DOC_T4$Treatment)
m4=gam(log(DOC..mg.L) ~ Treatment +  s(plant.mass..g, by= Treatment, k=8, m=1), data= DOC_T4, method= "REML")
summary.gam(m4)
gam.check(m4, rep=1000)
draw(m4)

```



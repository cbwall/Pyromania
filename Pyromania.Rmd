---
title: "Pyromania"
author: "C Wall"
date: "1/4/2021"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r setup chunk, setup, include = FALSE, cache=FALSE, message=FALSE, warning=FALSE}
if (!require('knitr')) install.packages('knitr'); library('knitr')
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.align='center')

# load packages
if (!require("pacman")) install.packages("pacman") # for rapid install if not in library

# use pacman to load all the packages you are missing!
pacman::p_load('knitr', 'lme4', 'lmerTest', 'tidyverse', 'magrittr', 'effects', 'plyr', 'dplyr', 
               'plotrix', 'car',"gridExtra", "cowplot", "tools", "mgcv", "gratia", "MASS", "stats",
               "tidymv")

```


###YSI  
Time 1 and Time 2: import YSI data and produce plots of changes in O2% and net ecosystem productivity (NEP) and net ecosystem respiration (NER)  
```{r YSI organized}
#load YSI data
YSI<-read.csv("data/Pyro_YSI.csv")

# fix date
YSI$Date<-as.character(YSI$Date)
YSI$Date<-as.POSIXct(YSI$Date, format="%m/%d/%Y")
YSI$Date<-as.Date(YSI$Date, format="%m/%d/%Y")


####### Time 1 change in O2 ################

#separate time points
YSI.T1<- YSI[(YSI$Time.point=="T1"),]

#calculate NEP for T1
T1.Prod<-YSI.T1[(YSI.T1$Date == "2021-11-15"),] # dawn and dusk for 12h period
T1.Dawn1<-T1.Prod[(T1.Prod$Dawn..Dusk == "dawn"),] # dawn-1 measurements
T1.Dusk<-T1.Prod[(T1.Prod$Dawn..Dusk == "dusk"),] # dusk measurements

T1.Dawn2<-YSI.T1[(YSI.T1$Date == "2021-11-16"),] # dawn-2 measurements, following AM

# make new dataframe
T1.O2<-(T1.Dawn1[,c(2,4:6)]) 
T1.O2$dawn1<-T1.Dawn1$DO.percent
T1.O2$dusk1<-T1.Dusk$DO.percent
T1.O2$dawn2<-T1.Dawn2$DO.percent

# NER = dusk - dawn (PM to AM, O2 change of day 1)
# NEP = dusk - dawn (PM to AM, O2 change of day 2)

T1.O2<- mutate(T1.O2, 
                NEP=dusk1 - dawn1,
                NER=dawn2 - dusk1) 

#sort
T1.O2<-T1.O2 %>% 
  arrange(Treatment, plant.mass..g) 


################ ################ ################
####### Time 2 change in O2 ################

#separate time points
YSI.T2<- YSI[(YSI$Time.point=="T2"),]

#calculate NEP for T2
T2.Prod<-YSI.T2[(YSI.T2$Date == "2021-12-06"),] # dawn and dusk for 12h period
T2.Dawn1<-T2.Prod[(T2.Prod$Dawn..Dusk == "dawn"),] # dawn-1 measurements
T2.Dusk<-T2.Prod[(T2.Prod$Dawn..Dusk == "dusk"),] # dusk measurements

T2.Dawn2<-YSI.T2[(YSI.T2$Date == "2021-12-07"),] # dawn-2 measurements, following AM

# make new dataframe
T2.O2<-(T2.Dawn1[,c(2,4:6)]) 
T2.O2$dawn1<-T2.Dawn1$DO.percent
T2.O2$dusk1<-T2.Dusk$DO.percent
T2.O2$dawn2<-T2.Dawn2$DO.percent

T2.O2<- mutate(T2.O2, 
                NEP=dusk1 - dawn1,
                NER=dawn2 - dusk1) 

#sort
T2.O2<-T2.O2 %>% 
  arrange(Treatment, plant.mass..g) 


################ ################ ################
####### Time 3 change in O2 ################

#separate time points
YSI.T3<- YSI[(YSI$Time.point=="T3"),]

#calculate NEP for T3
T3.Prod<-YSI.T3[(YSI.T3$Date == "2022-01-03"),] # dawn and dusk for 12h period
T3.Dawn1<-T3.Prod[(T3.Prod$Dawn..Dusk == "dawn"),] # dawn-1 measurements
T3.Dusk<-T3.Prod[(T3.Prod$Dawn..Dusk == "dusk"),] # dusk measurements

T3.Dawn2<-YSI.T3[(YSI.T3$Date == "2022-01-04"),] # dawn-2 measurements, following AM

# make new dataframe
T3.O2<-(T3.Dawn1[,c(2,4:6)]) 
T3.O2$dawn1<-T3.Dawn1$DO.percent
T3.O2$dusk1<-T3.Dusk$DO.percent
T3.O2$dawn2<-T3.Dawn2$DO.percent

T3.O2<- mutate(T3.O2, 
                NEP=dusk1 - dawn1,
                NER=dawn2 - dusk1) 

#sort
T3.O2<-T3.O2 %>% 
  arrange(Treatment, plant.mass..g) 

################ ################ ################
####### Time 3 change in O2 ################

#separate time points
YSI.T4<- YSI[(YSI$Time.point=="T4"),]

#calculate NEP for T4
T4.Prod<-YSI.T4[(YSI.T4$Date == "2022-02-02"),] # dawn and dusk for 12h period
T4.Dawn1<-T4.Prod[(T4.Prod$Dawn..Dusk == "dawn"),] # dawn-1 measurements
T4.Dusk<-T4.Prod[(T4.Prod$Dawn..Dusk == "dusk"),] # dusk measurements

T4.Dawn2<-YSI.T4[(YSI.T4$Date == "2022-02-03"),] # dawn-2 measurements, following AM

# make new dataframe
T4.O2<-(T4.Dawn1[,c(2,4:6)]) 
T4.O2$dawn1<-T4.Dawn1$DO.percent
T4.O2$dusk1<-T4.Dusk$DO.percent
T4.O2$dawn2<-T4.Dawn2$DO.percent

T4.O2<- mutate(T4.O2, 
                NEP=dusk1 - dawn1,
                NER=dawn2 - dusk1) 

#sort
T4.O2<-T4.O2 %>% 
  arrange(Treatment, plant.mass..g) 

################ ################ ################
# combine T1  T2  T3 T4 timepoints
################ ################ ################
O2.tanks<-rbind(T1.O2,T2.O2, T3.O2, T4.O2)

cols<-c("Time.point", "Treatment", "Tank") # columns to make factors
O2.tanks[cols] <- lapply(O2.tanks[cols], factor) # make all these factors
O2.tanks$plant.mass..g<-as.numeric(O2.tanks$plant.mass..g)
```
  
TIME POINT 1: Change in O2% and NEP and NER --   
make figures of the data for timepoint 1  
```{r Time1 O2}
########## 
Fig.formatting<-(theme_classic()) +
  theme(text=element_text(size=10),
        axis.line=element_blank(),
        legend.text.align = 0,
        legend.text=element_text(size=10),
        #legend.title = element_blank(),
        panel.border = element_rect(fill=NA, colour = "black", size=1),
        aspect.ratio=1, 
        axis.ticks.length=unit(0.25, "cm"),
        axis.text.y=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=10), 
        axis.text.x=element_text(
          margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=8)) +
  theme(legend.key.size = unit(0.4, "cm")) +
  theme(aspect.ratio=1.3) +
  theme(panel.spacing=unit(c(0, 0, 0, 0), "cm"))

#########################################################
############################################################################
###############################################################################################
###################

# total oxygen % plot for the 3 time points (dawn-dusk-dawn)

T1.AM1<-ggplot(T1.O2, aes(x=plant.mass..g, y=dawn1, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T1.dawn1")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

T1.PM1<-ggplot(T1.O2, aes(x=plant.mass..g, y=dusk1, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T1.dusk1")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

T1.AM2<-ggplot(T1.O2, aes(x=plant.mass..g, y=dawn2, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T1.dawn2")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

extract.legend <- get_legend(
  # create some space to the left of the legend
  T1.AM1 + theme(legend.box.margin = margin(0, 0, 0, 10)))

O2.T1<-plot_grid(
  T1.AM1+ theme(legend.position = "none"), 
  T1.PM1+ theme(legend.position = "none"), 
  T1.AM2+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,3), ncol=4)

#ggsave("figures/O2.T1.pdf", height=5, width=9)

#################################
############################################
# net ecosystem production and respiration

#Time 1 NEP
NEP.T1<-ggplot(T1.O2, aes(x=plant.mass..g, y=NEP, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Production (", Delta, "O"[2],"%)"))) +
  coord_cartesian(ylim=c(-20, 50)) +
  xlab("plant material (g)")+
  Fig.formatting

#Time 1 NER
NER.T1<-ggplot(T1.O2, aes(x=plant.mass..g, y=NER, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  coord_cartesian(ylim=c(-40, 10)) +
  ylab(expression(paste("Net Respiration (", Delta, "O"[2],"%)"))) +
  xlab("plant material (g)") +
  Fig.formatting


O2.change.T1<-plot_grid(
  NEP.T1+ theme(legend.position = "none") + ggtitle("Time 1"), 
  NER.T1+ theme(legend.position = "none") + ggtitle(""),
  extract.legend, 
  rel_widths = c(8,8,3), ncol=3)

#ggsave("figures/O2.change.T1.pdf", height=5, width=8)
```
  
TIME POINT 2: Change in O2% and NEP and NER --
make figures of the data for timepoint 2
```{r Time2 O2}
############################################################
##############################################################################
#############################################################################################
###################

# total oxygen % plot for the 3 time points (dawn-dusk-dawn)

T2.AM1<-ggplot(T2.O2, aes(x=plant.mass..g, y=dawn1, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T2.dawn1")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

T2.PM1<-ggplot(T2.O2, aes(x=plant.mass..g, y=dusk1, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T2.dusk1")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

T2.AM2<-ggplot(T2.O2, aes(x=plant.mass..g, y=dawn2, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T2.dawn2")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

O2.T2<-plot_grid(
  T2.AM1+ theme(legend.position = "none"), 
  T2.PM1+ theme(legend.position = "none"),
  T2.AM2+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,3), ncol=4)

#ggsave("figures/O2.T2.pdf", height=5, width=9)


############################################################
##############################################################################################
# net ecosystem production and respiration

#Time 2 NEP
NEP.T2<-ggplot(T2.O2, aes(x=plant.mass..g, y=NEP, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  coord_cartesian(ylim=c(-20, 50)) +
  ylab(expression(paste("Net Production (", Delta, "O"[2],"%)"))) +
  xlab("plant material (g)") +
  Fig.formatting

#Time 2 NER
NER.T2<-ggplot(T2.O2, aes(x=plant.mass..g, y=NER, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment),alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  coord_cartesian(ylim=c(-40, 10)) +
  ylab(expression(paste("Net Respiration (", Delta, "O"[2],"%)"))) +
  xlab("plant material (g)") +
  Fig.formatting

O2.change.T2<-plot_grid(
  NEP.T2+ theme(legend.position = "none") + ggtitle("Time 2"),
  NER.T2+ theme(legend.position = "none") + ggtitle(""),
  extract.legend, 
  rel_widths = c(8,8,3), ncol=3)

#ggsave("figures/O2.change.T2.pdf", height=5, width=8)


```

TIME POINT 3: Change in O2% and NEP and NER --
make figures of the data for timepoint 3
```{r Time3 O2}
############################################################
##############################################################################
#############################################################################################
###################

# total oxygen % plot for the 3 time points (dawn-dusk-dawn)

T3.AM1<-ggplot(T3.O2, aes(x=plant.mass..g, y=dawn1, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T3.dawn1")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

T3.PM1<-ggplot(T3.O2, aes(x=plant.mass..g, y=dusk1, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T3.dusk1")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

T3.AM2<-ggplot(T3.O2, aes(x=plant.mass..g, y=dawn2, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T3.dawn2")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

O2.T3<-plot_grid(
  T3.AM1+ theme(legend.position = "none"), 
  T3.PM1+ theme(legend.position = "none"),
  T3.AM2+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,3), ncol=4)

#ggsave("figures/O2.T3.pdf", height=5, width=9)


############################################################
##############################################################################################
# net ecosystem production and respiration

#Time 3 NEP
NEP.T3<-ggplot(T3.O2, aes(x=plant.mass..g, y=NEP, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  coord_cartesian(ylim=c(-20, 50)) +
  ylab(expression(paste("Net Production (", Delta, "O"[2],"%)"))) +
  xlab("plant material (g)") +
  Fig.formatting

#Time 3 NER
NER.T3<-ggplot(T3.O2, aes(x=plant.mass..g, y=NER, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment),alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  coord_cartesian(ylim=c(-40, 10)) +
  ylab(expression(paste("Net Respiration (", Delta, "O"[2],"%)"))) +
  xlab("plant material (g)") +
  Fig.formatting

O2.change.T3<-plot_grid(
  NEP.T3+ theme(legend.position = "none") + ggtitle("Time 3"),
  NER.T3+ theme(legend.position = "none") + ggtitle(""),
  extract.legend, 
  rel_widths = c(8,8,3), ncol=3)

#ggsave("figures/O2.change.T3.pdf", height=5, width=8)


```
  
TIME POINT 4: Change in O2% and NEP and NER --
make figures of the data for timepoint 4
```{r Time4 O2}
############################################################
##############################################################################
#############################################################################################
###################

# total oxygen % plot for the 3 time points (dawn-dusk-dawn)

T4.AM1<-ggplot(T4.O2, aes(x=plant.mass..g, y=dawn1, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T4.dawn1")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

T4.PM1<-ggplot(T4.O2, aes(x=plant.mass..g, y=dusk1, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T4.dusk1")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

T4.AM2<-ggplot(T4.O2, aes(x=plant.mass..g, y=dawn2, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ggtitle("T4.dawn2")+
  coord_cartesian(ylim=c(-30, 150)) +
  ylab(expression(paste("O"[2],"%"))) +
  xlab("plant material (g)") +
  Fig.formatting

O2.T4<-plot_grid(
  T4.AM1+ theme(legend.position = "none"), 
  T4.PM1+ theme(legend.position = "none"),
  T4.AM2+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,3), ncol=4)

#ggsave("figures/O2.T4.pdf", height=5, width=9)


############################################################
##############################################################################################
# net ecosystem production and respiration

#Time 4 NEP
NEP.T4<-ggplot(T4.O2, aes(x=plant.mass..g, y=NEP, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  coord_cartesian(ylim=c(-20, 50)) +
  ylab(expression(paste("Net Production (", Delta, "O"[2],"%)"))) +
  xlab("plant material (g)") +
  Fig.formatting

#Time 4 NER
NER.T4<-ggplot(T4.O2, aes(x=plant.mass..g, y=NER, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment),alpha=0.1) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  coord_cartesian(ylim=c(-40, 10)) +
  ylab(expression(paste("Net Respiration (", Delta, "O"[2],"%)"))) +
  xlab("plant material (g)") +
  Fig.formatting

O2.change.T4<-plot_grid(
  NEP.T4+ theme(legend.position = "none") + ggtitle("Time 4"),
  NER.T4+ theme(legend.position = "none") + ggtitle(""),
  extract.legend, 
  rel_widths = c(8,8,3), ncol=3)

#ggsave("figures/O2.change.T4.pdf", height=5, width=8)
```

```{r NEP NER compile}
########## ########## ########## ########## ########## 
########## compile all figs

##### All dawn-dusk-dawn measurements
O2change.alltimes<-plot_grid(
  O2.T1,
  O2.T2,
  O2.T3,
  O2.T4, ncol=1)

#ggsave("figures/O2change.alltimes.pdf", height=12, width=10)
```

Productivity models
```{r NEP models}
####### Time 1

m1.NEP.T1.gam=gam(NEP ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = O2.tanks, method = "REML")

summary(m1.NEP.T1.gam)
anova.gam(m1.NEP.T1.gam)
gam.check(m1.NEP.T1.gam, rep=1000)
draw(m1.NEP.T1.gam)
concrvity(m1.NEP.T1.gam)
par(mfrow = c(2, 2))
plot(m1.NEP.T1.gam, all.terms = TRUE, page=1)


#### see this https://cran.r-project.org/web/packages/tidymv/vignettes/plot-smooths.html
# The difference smooth is difference between the smooths of two conditions (two levels in a factor). 
# Portions of the difference smooth confidence interval that do not include 0 are shaded in red.

# model predictions
NEP.diff.T1<-plot_difference(
  m1.NEP.T1.gam,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
NEP.T1.mod.plot<-
  plot_smooths(
  model = m1.NEP.T1.gam,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=T1.O2, aes(x=plant.mass..g, y=NEP, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(-20, 50)) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Production (", Delta, "O"[2],"%)"))) +
  theme(legend.position = "right") +
  Fig.formatting

# no treatment effect (p=0.110), smoothers significant (p<0.006)

####### Time 2

m1.NEP.T2.gam=gam(NEP ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = O2.tanks, method = "REML")

summary(m1.NEP.T2.gam)
anova.gam(m1.NEP.T2.gam)
gam.check(m1.NEP.T2.gam, rep=1000)
draw(m1.NEP.T2.gam)
concrvity(m1.NEP.T2.gam)
par(mfrow = c(2, 2))
plot(m1.NEP.T2.gam, all.terms = TRUE, page=1)

## plot for the model output on rawdata
# model predictions
NEP.diff.T2<-plot_difference(
  m1.NEP.T2.gam,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

NEP.T2.mod.plot<-
  plot_smooths(
  model = m1.NEP.T2.gam,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=T2.O2, aes(x=plant.mass..g, y=NEP, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(-20, 50)) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Production (", Delta, "O"[2],"%)"))) +
  theme(legend.position = "right") +
  Fig.formatting

# treatment effect (p=0.007)
# smoother significant for burned (p=0.002) but not unburned (p=0.326)


####### Time 3

m1.NEP.T3.gam=gam(NEP ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = O2.tanks, method = "REML")

summary(m1.NEP.T3.gam)
anova.gam(m1.NEP.T3.gam)
gam.check(m1.NEP.T3.gam, rep=1000)
draw(m1.NEP.T3.gam)
concrvity(m1.NEP.T3.gam)
par(mfrow = c(2, 2))
plot(m1.NEP.T3.gam, all.terms = TRUE, page=1)

# model predictions
NEP.diff.T3<-plot_difference(
  m1.NEP.T3.gam,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

#plot for the model output on rawdata
NEP.T3.mod.plot<-
  plot_smooths(
  model = m1.NEP.T3.gam,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=T3.O2, aes(x=plant.mass..g, y=NEP, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(-20, 50)) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Production (", Delta, "O"[2],"%)"))) +
  theme(legend.position = "right") +
  Fig.formatting

# treatment effect (p=0.009)
# smoother significant for burned (p<0.001) but not unburned (p=0.053)


####### Time 4

m1.NEP.T4.gam=gam(NEP ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = O2.tanks, method = "REML")

summary(m1.NEP.T4.gam)
anova.gam(m1.NEP.T4.gam)
gam.check(m1.NEP.T4.gam, rep=1000)
draw(m1.NEP.T4.gam)
concrvity(m1.NEP.T4.gam)
par(mfrow = c(2, 2))
plot(m1.NEP.T4.gam, all.terms = TRUE, page=1)

# model predictions
NEP.diff.T4<-plot_difference(
  m1.NEP.T4.gam,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

#plot for the model output on rawdata
NEP.T4.mod.plot<-
  plot_smooths(
  model = m1.NEP.T4.gam,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=T4.O2, aes(x=plant.mass..g, y=NEP, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(-20, 50)) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Production (", Delta, "O"[2],"%)"))) +
  theme(legend.position = "right") +
  Fig.formatting

# no treatment effect (p=0.118)
# smoother significant for burned (p=0.020) but not unburned (p=0.327)


NEP.mod.plot<-plot_grid(
  NEP.T1.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-1"),
  NEP.T2.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-2"),
  NEP.T3.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-3"),
  NEP.T4.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-4"), extract.legend,
  rel_widths = c(8,8,8,8,3), ncol=5)

ggsave("figures/NEP.mod.plot.long.pdf", height=6, width=12)

#### model differences
NEP.mod.diffs<-plot_grid(
  NEP.diff.T1+ theme(legend.position = "none")+ ggtitle("Time-1"),
  NEP.diff.T2+ theme(legend.position = "none")+ ggtitle("Time-2"),
  NEP.diff.T3+ theme(legend.position = "none")+ ggtitle("Time-3"),
  NEP.diff.T4+ theme(legend.position = "none")+ ggtitle("Time-4"),
  rel_widths = c(8,8,8,8), ncol=4)

ggsave("figures/NEP.mod.diffs.pdf", height=3, width=10)

```

Respiration models
```{r NER models}
####### Time 1

m1.NER.T1.gam=gam(NER ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = O2.tanks, method = "REML")

summary(m1.NER.T1.gam)
anova.gam(m1.NER.T1.gam)
gam.check(m1.NER.T1.gam, rep=1000)
draw(m1.NER.T1.gam)
concrvity(m1.NER.T1.gam)
par(mfrow = c(2, 2))
plot(m1.NER.T1.gam, all.terms = TRUE, page=1)

# model predictions
NER.diff.T1<-plot_difference(
  m1.NER.T1.gam,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
NER.T1.mod.plot<-
  plot_smooths(
  model = m1.NER.T1.gam,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=T1.O2, aes(x=plant.mass..g, y=NER, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(-40, 10)) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Respiration (", Delta, "O"[2],"%)"))) +
  theme(legend.position = "right") +
  Fig.formatting

# no treatment effect (p=0.247), smoothers significant (p<0.003)

####### Time 2

m1.NER.T2.gam=gam(NER ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T2", data = O2.tanks, method = "REML")

summary(m1.NER.T2.gam)
anova.gam(m1.NER.T2.gam)
gam.check(m1.NER.T2.gam, rep=1000)
draw(m1.NER.T2.gam)
concrvity(m1.NER.T2.gam)
par(mfrow = c(2, 2))
plot(m1.NER.T2.gam, all.terms = TRUE, page=1)

# model predictions
NER.diff.T2<-plot_difference(
  m1.NER.T2.gam,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
NER.T2.mod.plot<-
  plot_smooths(
  model = m1.NER.T2.gam,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=T2.O2, aes(x=plant.mass..g, y=NER, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(-40, 10)) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Respiration (", Delta, "O"[2],"%)"))) +
  theme(legend.position = "right") +
  Fig.formatting

# slight treatment effect (p=0.085)
# smoother significant for both burned and unburned (p<0.008)


####### Time 3

m1.NER.T3.gam=gam(NER ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T3", data = O2.tanks, method = "REML")

summary(m1.NER.T3.gam)
anova.gam(m1.NER.T3.gam)
gam.check(m1.NER.T3.gam, rep=1000)
draw(m1.NER.T3.gam)
concrvity(m1.NER.T3.gam)
par(mfrow = c(2, 2))
plot(m1.NER.T3.gam, all.terms = TRUE, page=1)

# model predictions
NER.diff.T3<-plot_difference(
  m1.NER.T3.gam,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
NER.T3.mod.plot<-
  plot_smooths(
  model = m1.NER.T3.gam,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=T3.O2, aes(x=plant.mass..g, y=NER, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(-40, 10)) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Respiration (", Delta, "O"[2],"%)"))) +
  theme(legend.position = "right") +
  Fig.formatting

# treatment effect (p=0.027)
# smoother significant for burned and unnburned (p<0.001)


####### Time 4

m1.NER.T4.gam=gam(NER ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T4", data = O2.tanks, method = "REML")

summary(m1.NER.T4.gam)
anova.gam(m1.NER.T4.gam)
gam.check(m1.NER.T4.gam, rep=1000)
draw(m1.NER.T4.gam)
concrvity(m1.NER.T4.gam)
par(mfrow = c(2, 2))
plot(m1.NER.T4.gam, all.terms = TRUE, page=1)

# model predictions
NER.diff.T4<-plot_difference(
  m1.NER.T4.gam,
  series = plant.mass..g,
  difference = list(Treatment = c("burned", "unburned"))
)

###########  
#plot for the model output on rawdata
NER.T4.mod.plot<-
  plot_smooths(
  model = m1.NER.T4.gam,
  series = plant.mass..g,
  comparison = Treatment
) + 
  geom_point(data=T4.O2, aes(x=plant.mass..g, y=NER, color=Treatment)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  coord_cartesian(ylim=c(-40, 10)) +
  geom_hline(yintercept=0, linetype="longdash", color = "gray") +
  ylab(expression(paste("Net Respiration (", Delta, "O"[2],"%)"))) +
  theme(legend.position = "right") +
  Fig.formatting

# no treatment effect (p=0.078)
# smoother significant for burned (p=0.004) but not unburned (p=0.965)


NER.mod.plot<-plot_grid(
  NER.T1.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-1"),
  NER.T2.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-2"),
  NER.T3.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-3"),
  NER.T4.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-4"), extract.legend,
  rel_widths = c(8,8,8,8,3), ncol=5)

#ggsave("figures/NER.mod.plot.long.pdf", height=6, width=12)

#### model differences
NER.mod.diffs<-plot_grid(
  NER.diff.T1+ theme(legend.position = "none")+ ggtitle("Time-1"),
  NER.diff.T2+ theme(legend.position = "none")+ ggtitle("Time-2"),
  NER.diff.T3+ theme(legend.position = "none")+ ggtitle("Time-3"),
  NER.diff.T4+ theme(legend.position = "none")+ ggtitle("Time-4"),
  rel_widths = c(8,8,8,8), ncol=4)

#ggsave("figures/NER.mod.diffs.pdf", height=3, width=10)
```


```{r NEP NER model plots}
NEP.NER.alltimes.long<-plot_grid(
  NEP.T1.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-1"),
  NEP.T2.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-2"),
  NEP.T3.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-3"),
  NEP.T4.mod.plot+ theme(legend.position = "none")+ ggtitle("Time-4"), extract.legend,
  NER.T1.mod.plot+ theme(legend.position = "none")+ ggtitle(""),
  NER.T2.mod.plot+ theme(legend.position = "none")+ ggtitle(""),
  NER.T3.mod.plot+ theme(legend.position = "none")+ ggtitle(""),
  NER.T4.mod.plot+ theme(legend.position = "none")+ ggtitle(""), extract.legend,
  rel_widths = c(8,8,8,8,3, 8,8,8,8,3), ncol=5)
ggsave("figures/NEP.NER.alltimes.long.pdf", height=7, width=12)

NEP.NER.mod.diffs<-plot_grid(
  NEP.diff.T1+ theme(legend.position = "none")+ ggtitle("NEP- Time-1"),
  NEP.diff.T2+ theme(legend.position = "none")+ ggtitle("Time-2"),
  NEP.diff.T3+ theme(legend.position = "none")+ ggtitle("Time-3"),
  NEP.diff.T4+ theme(legend.position = "none")+ ggtitle("Time-4"),
  NER.diff.T1+ theme(legend.position = "none")+ ggtitle("NER"),
  NER.diff.T2+ theme(legend.position = "none")+ ggtitle(""),
  NER.diff.T3+ theme(legend.position = "none")+ ggtitle(""),
  NER.diff.T4+ theme(legend.position = "none")+ ggtitle(""),
  rel_widths = c(8,8,8,8,8,8,8,8), ncol=4)
ggsave("figures/NEP.NER.mod.diffs.pdf", height=7, width=12)
```
  
###Chlorophyll  
import   
- may not be useful...
```{r chlorophyll}
## import treatment IDs
chl.dat<- read.csv("data/Pyro_chlorophyll.csv")  
chl.dat<-chl.dat[!(chl.dat$Time.point=="First.round"),] # remove first round from aborted mission

#remove outlier
chl.out.rem<-chl.dat[!(chl.dat$chla..ug.L>=10),]


#plot

chla.T0<-ggplot(chl.dat[(chl.dat$Time.point=="T0"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-0") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting


chla.T1<-ggplot(chl.dat[(chl.dat$Time.point=="T1"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-1") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T2<-ggplot(chl.dat[(chl.dat$Time.point=="T2"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-2") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T3<-ggplot(chl.dat[(chl.dat$Time.point=="T3"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-3") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting

chla.T4<-ggplot(chl.dat[(chl.dat$Time.point=="T4"),], aes(x=plant.mass..g, y=chla..ug.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 20)) +
  ggtitle("Time-4") +
  ylab(expression(paste("chlorophyll", ~(mu*g~L^-1), sep=""))) +
  xlab("plant material (g)") +
  Fig.formatting


chl.plots<-plot_grid(
  chla.T0+ theme(legend.position = "none"),
  chla.T1+ theme(legend.position = "none"),
  chla.T2+ theme(legend.position = "none"),
  chla.T3+ theme(legend.position = "none"),
  chla.T4+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,8,8,3), ncol=6)


chl.plots

ggsave("figures/chla.alltime.pdf", height=5, width=15)



```
  
  
###DOC  
import and do a loop to clean up all files and make stacked data in single df
```{r DOC}
## import treatment IDs
IDs<-read.csv("data/treatment.IDs.csv")

##### grab files in a list
Total.DOC.files <- list.files(path="data/DOC.TN", pattern = "csv$", full.names = T)
Total.DOC.files

##### what are the file names, sans extensions using package 'tools'
file.names<-file_path_sans_ext(list.files(path="data/DOC.TN", pattern = "csv$", full.names = F))
file.names
############ formatting all data in for loop
  for(i in 1:length(Total.DOC.files))
    {
  data<-read.csv(Total.DOC.files[i], sep=",")
  data<-data[,c(1,3,4)] # removed columns we don't need
  data$File<-Total.DOC.files[i]
  colnames(data)<-c("Tank", "DOC..mg.L", "TN..mg.L", "File")
  data$Tank<- IDs$Tank
  data$Tank<-as.numeric(as.character(data$Tank)) # make the column of samples all numeric
  data <- data[!is.na(as.numeric(as.character(data$Tank))),] # remove all rows that aren't numeric/tanks
  data$Treatment<-IDs$Treatment
  data$plant.mass..g<-IDs$plant.mass..g
  make.names(assign(paste(file.names[i], sep=""), data)) # make the file name the name of new df for loop df
  }
########## this is the end of the loop


ls() #see all dfs you've made, the above will be df matching their file names

#Combine files from loop to single df
DOC.df<-rbind(DOC_T0, DOC_T1, DOC_T2, DOC_T3, DOC_T4)

DOC.df$File <- sapply(strsplit(DOC.df$File, "/"), `[`, 3) # extract sample names

# alternative way to code the above
#give the 10th-24th character of the file name, removing the rest
#DOC.df$File<-substr(DOC.df$File, 13, 27) 

#alternatively
# remove the 9 letters ('^.) at start 
# remove the 4 letters (.$') at end
#DOC.df$File<-gsub('^.........|....$', '', DOC.df$File) 

# if equals DOC_T0_11052021 then, T0, if not then T1
DOC.df$Time.point<- as.factor(ifelse(DOC.df$File=="DOC_T0.csv", "T0",
         ifelse (DOC.df$File=="DOC_T1.csv", "T1",
           ifelse (DOC.df$File=="DOC_T2.csv", "T2", 
                   ifelse(DOC.df$File=="DOC_T3.csv", "T3", "T4")))))

#rearrange
DOC.df<- DOC.df %>% 
  select(File, Time.point, Treatment, Tank, plant.mass..g, DOC..mg.L, TN..mg.L) 

DOC.df$Treatment<-as.factor(DOC.df$Treatment)
```

DOC plots
```{r DOC plots}
DOC.T0<-ggplot(DOC.df[(DOC.df$Time.point=="T0"),], aes(x=plant.mass..g, y=DOC..mg.L, color=Treatment)) +
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Time-0") +
  ylab("DOC (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting

DOC.T1<-ggplot(DOC.df[(DOC.df$Time.point=="T1"),], aes(x=plant.mass..g, y=DOC..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Time-1") +
  ylab("DOC (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting
  
DOC.T2<-ggplot(DOC.df[(DOC.df$Time.point=="T2"),], aes(x=plant.mass..g, y=DOC..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Time-2") +
  ylab("DOC (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting

  
DOC.T3<-ggplot(DOC.df[(DOC.df$Time.point=="T3"),], aes(x=plant.mass..g, y=DOC..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Time-3") +
  ylab("DOC (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting

DOC.T4<-ggplot(DOC.df[(DOC.df$Time.point=="T4"),], aes(x=plant.mass..g, y=DOC..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 60)) +
  ggtitle("Time-4") +
  ylab("DOC (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting

DOC.plots<-plot_grid(
  #DOC.T0+ theme(legend.position = "none"),
  DOC.T1+ theme(legend.position = "none"),
  DOC.T2+ theme(legend.position = "none"),
  DOC.T3+ theme(legend.position = "none"),
  DOC.T4+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,8, 3), ncol=5)


DOC.plots

ggsave("figures/DOC.alltime.pdf", height=5, width=15)

```
  
DOC analysis: 

- notes on GAMS....
Note that fitting via restricted maximum likelihood (REML) is advised to give stable results. Fitting the smoothing parameter (sp) to user defined levels not advisable (but certainly is done). 
Number of basis functions important as well, small # of basis functions (k) will limit wiggliness (and make the model more linear than should be). This wiggliness is set by using the k values. Don't want too high, or too low... 

When using the non-linear smoothing, this is the s(xxxx). Can add a new predictor by adding another smooth function with s(x1) + s(x2). When the variable is inside the smooth function, this is to account for the nonlinear shape. Two smoothing together and you have ADDITIVE Nonlinear modeling. Not all variables need to be non-linear, but adding a predictor outside of the s() then this is allowing for linearity. 

In practce, continuous variables are rarely linear in GAMs, automatic smoothing will make a linear shape if setting high smoothing function (ie.. s =1000), then a non-linear variable appears linear. However, setting categorical variables as predicots linear is more common.

Factor-smooth interaction also an option, this is when s(x1 by = fac), this sets different smoothing for different variables of "fac". Usually, the different smoothers are combined with a varying intercept incase the different categories are different in means and slopes, this would be by adding the s(x1 by = fac) + fac, wheere the +fac allows for a different slope

EDF - effective degrees of freedom, equate with wiggliness, with edf =1 as a straight line, and higher edfs as more wiggly. GAM smoother significance is described as not being able to draw a horizontal line through the data. Always check concurvity, which is the collinearity with models from 0-1.

```{r DOC analysis}

######## T1 model
m1.DOC.T1.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, by= Treatment), subset = Time.point=="T1", data = DOC.df, method = "REML")

summary(m1.DOC.T1.gam)
anova.gam(m1.DOC.T1.gam)
gam.check(m1.gam, rep=1000)
draw(m1.DOC.T1.gam)
concrvity(m1.DOC.T1.gam)
par(mfrow = c(2, 2))
plot(m1.DOC.T1.gam, all.terms = TRUE, page=1)

# effect of treatment, smoothing significant across both treatments
# DOC higher in  unburned, relative to burned


########## T2
m1.DOC.T2.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, by=Treatment), subset = Time.point=="T2", data = DOC.df, method = "REML")
summary(m1.DOC.T2.gam)
# no treatment effect

m2.DOC.T2.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g), subset = Time.point=="T2", data = DOC.df, method = "REML")
AIC(m1.DOC.T2.gam, m2.DOC.T2.gam)
# model m1.DOC.T2.gam preferred despite no effect of treatment

summary(m1.DOC.T2.gam)
anova.gam(m1.DOC.T2.gam)
gam.check(m1.DOC.T2.gam, rep=1000)
draw(m1.DOC.T2.gam)
concrvity(m1.DOC.T2.gam)
par(mfrow = c(2, 2))
plot(m1.DOC.T2.gam, all.terms = TRUE, page=1)

# NO effect of treatment, smoothing significant across both treatments
# DOC equivalent in burned and unburned 
# DOC more variable/wonky across gradient in burned


########## T3
m3.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, by=Treatment), subset = Time.point=="T3", data = DOC.df, method = "REML")
# significant treatment p=0.002 and smoothers (p<0.001)
summary(m3.gam)
anova.gam(m3.gam)
gam.check(m3.gam, rep=1000)
draw(m3.gam)
concrvity(m3.gam)
par(mfrow = c(2, 2))
plot(m3.gam, all.terms = TRUE, page=1)

# effect of treatment, smoothing significant across both treatments
# DOC higher in  burned vs. unburned


########## T4
m1.DOC.T4.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g, by=Treatment), subset = Time.point=="T4", data = DOC.df, method = "REML")
summary(m1.DOC.T4.gam)
# no treatment effect

m2.DOC.T4.gam=gam(DOC..mg.L ~ Treatment + s(plant.mass..g), subset = Time.point=="T4", data = DOC.df, method = "REML")
AIC(m1.DOC.T4.gam, m2.DOC.T4.gam)
# model m2.DOC.T4.gam preferred


summary(m2.DOC.T4.gam)
anova.gam(m2.DOC.T4.gam)
gam.check(m2.DOC.T4.gam, rep=1000)
draw(m2.DOC.T4.gam)
concrvity(m2.DOC.T4.gam)
par(mfrow = c(2, 2))
plot(m2.DOC.T4.gam, all.terms = TRUE, page=1)

# no effect of treatment, smoothing significant across both treatments
# DOC equivalent in  burned and unburned

```

Total N plots
```{r TN plots}
TN.T0<-ggplot(DOC.df[(DOC.df$Time.point=="T0"),], aes(x=plant.mass..g, y=TN..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 2)) +
  ggtitle("Time-0") +
  ylab("TN (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting
 
TN.T1<-ggplot(DOC.df[(DOC.df$Time.point=="T1"),], aes(x=plant.mass..g, y=TN..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 2)) +
  ggtitle("Time-1") +
  ylab("TN (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting

TN.T2<-ggplot(DOC.df[(DOC.df$Time.point=="T2"),], aes(x=plant.mass..g, y=TN..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 2)) +
  ggtitle("Time-2") +
  ylab("TN (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting

TN.T3<-ggplot(DOC.df[(DOC.df$Time.point=="T3"),], aes(x=plant.mass..g, y=TN..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 2)) +
  ggtitle("Time-3") +
  ylab("TN (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting

TN.T4<-ggplot(DOC.df[(DOC.df$Time.point=="T4"),], aes(x=plant.mass..g, y=TN..mg.L, color=Treatment)) + 
  geom_point() +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  coord_cartesian(ylim=c(0, 2)) +
  ggtitle("Time-4") +
  ylab("TN (mg/L)") +
  xlab("plant material (g)") +
  Fig.formatting
  
TN.plots<-plot_grid(
  #TN.T0+ theme(legend.position = "none"),
  TN.T1+ theme(legend.position = "none"),
  TN.T2+ theme(legend.position = "none"),
  TN.T3+ theme(legend.position = "none"),
  TN.T4+ theme(legend.position = "none"),
  extract.legend, 
  rel_widths = c(8,8,8,8,3), ncol=5)

ggsave("figures/TN.alltime.pdf", height=5, width=15)

```

```{r TN analysis}

######## T1 model
m1.TN.T1.gam=gam(TN..mg.L ~ Treatment + s(plant.mass..g, by=Treatment), 
              subset = Time.point=="T1", data = DOC.df, method = "REML")
summary(m1.TN.T1.gam)

# no treatment effect, compare to simplified model (p=0.901)

m2.TN.T1.gam=gam(TN..mg.L ~ Treatment + s(plant.mass..g), 
              subset = Time.point=="T1", data = DOC.df, method = "REML")

AIC(m1.TN.T1.gam, m2.TN.T1.gam)
# m2.TN.T1.gam preferred

summary(m2.TN.T1.gam)
anova.gam(m2.TN.T1.gam)
gam.check(m2.TN.T1.gam, rep=1000)
draw(m2.TN.T1.gam)
concrvity(m2.TN.T1.gam)
par(mfrow = c(2, 2))
plot(m2.TN.T1.gam, all.terms = TRUE, page=1)

# TN smoother significant for unburned but not burned (p=0.003)


######## T2 model
m1.TN.T2.gam=gam(TN..mg.L ~ Treatment + s(plant.mass..g, by=Treatment), 
              subset = Time.point=="T2", data = DOC.df, method = "REML")
summary(m1.TN.T2.gam)
# no treatment effect, compare to simplified model (p=0.083)

m2.TN.T2.gam=gam(TN..mg.L ~ Treatment + s(plant.mass..g), 
              subset = Time.point=="T2", data = DOC.df, method = "REML")

AIC(m1.TN.T2.gam, m2.TN.T2.gam)
# m2.TN.T2.gam preferred

summary(m2.TN.T2.gam)
anova.gam(m2.TN.T2.gam)
gam.check(m2.TN.T2.gam, rep=1000)
draw(m2.TN.T2.gam)
concrvity(m2.TN.T2.gam)
par(mfrow = c(2, 2))
plot(m2.TN.T2.gam, all.terms = TRUE, page=1)

# Near treatment effect p=0.053, higher TN in unburned
# smoother signif: 0.004


######## T3 model
m1.TN.T3.gam=gam(TN..mg.L ~ Treatment + s(plant.mass..g, by=Treatment), 
              subset = Time.point=="T3", data = DOC.df, method = "REML")
summary(m1.TN.T3.gam)
# no treatment effect, compare to simplified model (p=0.075)

m2.TN.T3.gam=gam(TN..mg.L ~ Treatment + s(plant.mass..g), 
              subset = Time.point=="T3", data = DOC.df, method = "REML")

AIC(m1.TN.T3.gam, m2.TN.T3.gam)
# m1.TN.T3.gam preferred, 

summary(m1.TN.T3.gam)
anova.gam(m1.TN.T3.gam)
gam.check(m1.TN.T3.gam, rep=1000)
draw(m1.TN.T3.gam)
concrvity(m1.TN.T3.gam)
par(mfrow = c(2, 2))
plot(m1.TN.T3.gam, all.terms = TRUE, page=1)

# Near treatment effect p=0.075, trend for higher TN in burned
# smoother signif: at <0.001 for both


######## T4 model
m1.TN.T4.gam=gam(TN..mg.L ~ Treatment + s(plant.mass..g, by=Treatment), 
              subset = Time.point=="T4", data = DOC.df, method = "REML")
summary(m1.TN.T4.gam)
# treatment effect, compare to simplified model (p=0.020)

m2.TN.T4.gam=gam(TN..mg.L ~ Treatment + s(plant.mass..g), 
              subset = Time.point=="T4", data = DOC.df, method = "REML")

AIC(m1.TN.T4.gam, m2.TN.T4.gam)
# m1.TN.T4.gam preferred

summary(m1.TN.T4.gam)
anova.gam(m1.TN.T4.gam)
gam.check(m1.TN.T4.gam, rep=1000)
draw(m1.TN.T4.gam)
concrvity(m1.TN.T4.gam)
par(mfrow = c(2, 2))
plot(m1.TN.T4.gam, all.terms = TRUE, page=1)


# effect of treatment (higher TN in the burned)
# significant smoother effect for burned treatment only

```


### Isotopes
Time 1 isotopes
```{r isotopes d15N}

#########  Time 1
topes<-read.csv("data/Isotopes/Pyro_isotopes.csv")
topes$C.N <-(topes$Total.C..ug/12)/(topes$Total.N..ug/14) # C mol : N mol

cols<-c("Time.point", "Treatment", "Type", "Tank") # columns to make factors
topes[cols] <- lapply(topes[cols], factor) # make all these factors

##### make data frames
# treatment data df
topes.trt<-topes[(topes$Treatment=="burned" | topes$Treatment=="unburned"),]

# control and start plant materials df
topes.controls<-topes[!(topes$Treatment=="burned" | topes$Treatment=="unburned"),]

#### isotope plots for treatments

iso.plot.T1<-ggplot(topes.trt[(topes.trt$Time.point=="T1"),], 
                 aes(x=plant.mass..g, y=d15N, color=Treatment, linetype=Type)) +
  geom_point(aes(shape=Type)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  ylab(expression(paste(delta^{15}, N, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  coord_cartesian(ylim=c(0, 250)) +
  Fig.formatting +
  theme(legend.key.size = unit(2,"line"))

############ Time 2

#### isotope plots for treatments
iso.plot.T2<-ggplot(topes.trt[(topes.trt$Time.point=="T2"),],
                 aes(x=plant.mass..g, y=d15N, color=Treatment, linetype=Type)) +
  geom_point(aes(shape=Type)) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  ylab(expression(paste(delta^{15}, N, " (\u2030, air)"))) +
  xlab("plant material (g)") +
  coord_cartesian(ylim=c(0, 250)) +
  Fig.formatting +
  theme(legend.key.size = unit(2,"line"))

##########
extract.legend.iso <- get_legend(
  # create some space to the left of the legend
  iso.plot.T1 + theme(legend.box.margin = margin(0, 0, 0, 10)))

###### group plot
isotope.plots<-plot_grid(
  iso.plot.T1+ theme(legend.position = "none") + ggtitle("Time-1"),
  iso.plot.T2+ theme(legend.position = "none") + ggtitle("Time-2") ,
  extract.legend.iso, 
  rel_widths = c(8,8,3), ncol=3)

ggsave("figures/Isotope.d15N.pdf", height=5, width=8, encod="MacRoman")
```

C:N ratio for plankton
```{r isotopes CN}
############# C vs N plot

### Time 1 C vs. N
iso.plot.CN.T1<-ggplot(topes.trt[(topes.trt$Time.point=="T1"),],
                    aes(x=Total.C..ug, y=Total.N..ug, color=Treatment)) +
  geom_point(aes(shape=Type)) +
  ggtitle("Time-1")+
  scale_shape_manual(name="Plankton", values = c(17, 16), 
                     labels = c(expression(paste("> 63"~mu,"m")), 
                                expression(paste("< 63"~mu,"m")))) +
  scale_color_manual(name="Treatments", values = c("brown1", "mediumseagreen")) +
  # having this repeated below for some reason hacks the legend in a positive way, so leave it in.
  scale_color_manual(values = c("brown1", "mediumseagreen")) + 
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1) +
  ylim(c(0,550)) +
  xlim(c(0,3000)) +
  ylab("Total N (ug)") +
  xlab("Total C (ug)") +
  Fig.formatting +
  theme(legend.key.size = unit(2,"line"))


### Time 2 C vs. N
iso.plot.CN.T2<-ggplot(topes.trt[(topes.trt$Time.point=="T2"),],
                    aes(x=Total.C..ug, y=Total.N..ug, color=Treatment)) +
  geom_point(aes(shape=Type)) +
  ggtitle("Time-2")+
  scale_shape_manual(name="Plankton", values = c(17, 16), 
                     labels = c(expression(paste("> 63"~mu,"m")), 
                                expression(paste("< 63"~mu,"m")))) +
  scale_color_manual(name="Treatments", values = c("brown1", "mediumseagreen")) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1, show.legend = FALSE) +
  ylim(c(0,550)) +
  xlim(c(0,3000)) +
  ylab("Total N (ug)") +
  xlab("Total C (ug)") +
  Fig.formatting +
  theme(legend.key.size = unit(2,"line"))


######### C:N ratio plot by biomass
iso.plot.CNrat.T1<-ggplot(topes.trt[(topes.trt$Time.point=="T1"),], 
                         aes(y=C.N, x=plant.mass..g, color=Treatment)) +
  geom_point(aes(shape=Type)) +
  ggtitle("Time-1")+ 
  coord_cartesian(ylim=c(0, 20)) +
  scale_shape_manual(name="Plankton", values = c(17, 16), 
                     labels = c(expression(paste("> 63"~mu,"m")), 
                                expression(paste("< 63"~mu,"m")))) +
  scale_color_manual(name="Treatments", values = c("brown1", "mediumseagreen")) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1, show.legend = FALSE) +
  ylab("C:N") +
  xlab("plant material (g)") +
  Fig.formatting +
  theme(legend.key.size = unit(2,"line"))


######## Time 2
iso.plot.CNrat.T2<-ggplot(topes.trt[(topes.trt$Time.point=="T2"),], 
                         aes(y=C.N, x=plant.mass..g, color=Treatment)) +
  geom_point(aes(shape=Type)) +
  ggtitle("Time-2")+ 
  coord_cartesian(ylim=c(0, 20)) +
  scale_shape_manual(name="Plankton", values = c(17, 16), 
                     labels = c(expression(paste("> 63"~mu,"m")), 
                                expression(paste("< 63"~mu,"m")))) +
  scale_color_manual(name="Treatments", values = c("brown1", "mediumseagreen")) +
  scale_color_manual(values = c("brown1", "mediumseagreen")) +
  geom_smooth(method=loess, aes(fill=Treatment), alpha=0.1, show.legend = FALSE) +
  ylab("C:N") +
  xlab("plant material (g)") +
  Fig.formatting +
  theme(legend.key.size = unit(2,"line"))


### get legend
extract.legend.iso2 <- get_legend(
  # create some space to the left of the legend
  iso.plot.CN.T1 + theme(legend.box.margin = margin(0, 0, 0, 10)))

## combine plots
isoCNplot<- plot_grid(iso.plot.CN.T1 + theme(legend.position = "none"), 
                    iso.plot.CN.T2 + theme(legend.position = "none"),
                    iso.plot.CNrat.T1 + theme(legend.position = "none"),
                    iso.plot.CNrat.T2 + theme(legend.position = "none"),
                    extract.legend.iso2, rel_widths = c(8,8,8,8,3), ncol=5)

isoCNplot
ggsave("figures/iso.plot.CN.alltime.pdf", encod="MacRoman", height=6, width=15)
```

C.N models
```{r  CN models}
############# all plankton T1
m1a.T1.CN <- gam(C.N ~ Treatment*Type +
            s(plant.mass..g, by=Treatment), 
            subset = Time.point=="T1", data=topes.trt, method="REML", family="gaussian")

m1b.T1.CN <- gam(C.N ~ Treatment + Type +
            s(plant.mass..g, by=Treatment), 
            subset = Time.point=="T1", data=topes.trt, method="REML", family="gaussian")

AIC(m1a.T1.CN, m1b.T1.CN)
## additive model best fit, but no treatment or type effect

summary(m1b.T1.CN)
anova.gam(m1b.T1.CN)
gam.check(m1b.T1.CN, rep=1000)
draw(m1b.T1.CN)
concrvity(m1b.T1.CN)
par(mfrow = c(1, 2))
plot(m1b.T1.CN, all.terms = TRUE, page=1)

# no effect of type or treatment
# smoother significant for both 

########### Time 2
m1a.T2.CN <- gam(C.N ~ Treatment*Type +
            s(plant.mass..g, by=Treatment), 
            subset = Time.point=="T2", data=topes.trt, method="REML", family="gaussian")

m1b.T2.CN <- gam(C.N ~ Treatment + Type +
            s(plant.mass..g, by=Treatment), 
            subset = Time.point=="T2", data=topes.trt, method="REML", family="gaussian")

AIC(m1a.T2.CN, m1b.T2.CN)
## additive model best fit

summary(m1b.T2.CN)
anova.gam(m1b.T2.CN)
gam.check(m1b.T2.CN, rep=1000)
draw(m1b.T2.CN)
concrvity(m1b.T2.CN)
par(mfrow = c(1, 2))
plot(m1b.T2.CN, all.terms = TRUE, page=1)

# no effect of treatment, but type important (higher in POM)
# smoother significant for both 
```

```{r control isotopes}
########## ########## ########## 
########## control plots
# set levels
topes.controls$Type<-factor(topes.controls$Type, 
                         levels=c("blank", "plankton.stock", 
                                  "willow.unburned", "willow.burned",
                                  "sage.unburned", "sage.burned", 
                                  "sage.veryburned", "sage.stem.burned"))

# make a burning treatment
topes.controls$Burn.Trt=as.factor(word(topes.controls$Type, -1, sep="[.]"))

# make a plant name
topes.controls$Plant=as.factor(word(topes.controls$Type, 1, sep="[.]"))

### test some models on controls
# remove blanks and plankton, keeping only plants
topes.controls.plants<-topes.controls[!(topes.controls$Plant=="blank" |
                                          topes.controls$Plant=="plankton" ),]
topes.controls.plants$Plant<-droplevels(topes.controls.plants$Plant)

# keep only non-enriched samples (remove sage)
topes.controls.non.enrich<-topes.controls[!(topes.controls$Plant=="blank" |
                                          topes.controls$Plant=="sage" ),]
topes.controls.non.enrich$Plant<-droplevels(topes.controls.non.enrich$Plant)


######## test plant species differences
wilcox.test(d15N~Plant, data=topes.controls.plants) # d15N sage and willow differ (p<0.001)
wilcox.test(C.N~Plant, data=topes.controls.plants) # C.N sage and willow differ (p=0.013)
par(mfrow=c(1,2))
boxplot(d15N~Plant, data=topes.controls.plants)
boxplot(C.N~Plant, data=topes.controls.plants)


######## test difference between willow and plankton 
wilcox.test(d15N~Plant, data=topes.controls.non.enrich) # d15N plankton and willow differ (p<0.001)
wilcox.test(C.N~Plant, data=topes.controls.non.enrich) # C:N plankton and willow differ (p<0.001)
par(mfrow=c(1,2))
boxplot(d15N~Plant, data=topes.controls.non.enrich)
boxplot(C.N~Plant, data=topes.controls.non.enrich)


############# separate plant dfs
#### Sage d15N
topes.controls.sage<-topes.controls[(topes.controls$Plant=="sage"),]
topes.controls.sage$Plant<-droplevels(topes.controls.sage$Plant)
topes.controls.sage$Burn.Trt<-droplevels(topes.controls.sage$Burn.Trt)

# how do different types of sage compare across burn/unburn
mod.sage<-lm(d15N~Burn.Trt, data=topes.controls.sage)
anova(mod.sage) 
# no difference in d15N for burned, unburned, very burned sage (p=0.423)

#### Sage C.N
mod.sage.CN<-lm(C.N~Burn.Trt, data=topes.controls.sage)
anova(mod.sage.CN) 
# Sage: difference in unburned, burned, very burned for C:N

par(mfrow=c(1,2))
boxplot(d15N~Burn.Trt, data=topes.controls.sage)
boxplot(C.N~Burn.Trt, data=topes.controls.sage)



###########################
#### Willow d15N
topes.controls.will<-topes.controls[(topes.controls$Plant=="willow"),]
topes.controls.will$Plant<-droplevels(topes.controls.will$Plant)
topes.controls.will$Burn.Trt<-droplevels(topes.controls.will$Burn.Trt)

mod<-lm(d15N~Burn.Trt, data=topes.controls.will)
anova(mod) 
# no difference in burned/unburned willow d15N

#### Willow C.N
wilcox.test(C.N~Burn.Trt, data=topes.controls.will)
# Willow: no difference in unburned, burned C:N (p=0.114)

par(mfrow=c(1,2))
boxplot(d15N~Burn.Trt, data=topes.controls.will)
boxplot(C.N~Burn.Trt, data=topes.controls.will)


######### make summary dfs
# summarize by plants
d15N.plant<-aggregate(d15N~Plant, topes.controls, FUN=mean)
d15N.plantSD<-aggregate(d15N~Plant, topes.controls, FUN=length)
d15N.plant[3]<-d15N.plantSD[2]
colnames(d15N.plant)<-c("Plant", "d15N", "SD")

CN.plant<-aggregate(C.N~Plant, topes.controls, FUN=mean)
CN.plantSD<-aggregate(C.N~Plant, topes.controls, FUN=sd)
CN.plant[3]<-CN.plantSD[2]
colnames(CN.plant)<-c("Plant", "C.N", "SD")

# summary df d15N
d15N.cont<-aggregate(d15N~Type, topes.controls, FUN=mean)
d15N.cont.n<-aggregate(d15N~Type, topes.controls, FUN=length)
d15N.cont.SD<-aggregate(d15N~Type, topes.controls, FUN=sd)
d15N.cont[3]<- d15N.cont.SD[2]
d15N.cont[4]<- d15N.cont.n[2]
colnames(d15N.cont)<-c("Type", "d15N", "SD", "n")

# summary df control C:N
CN.cont<-aggregate(C.N~Type, topes.controls, FUN=mean)
CN.cont.n<-aggregate(C.N~Type, topes.controls, FUN=length)
CN.cont.SD<-aggregate(C.N~Type, topes.controls, FUN=sd)
CN.cont[3]<- CN.cont.SD[2]
CN.cont[4]<- CN.cont.n[2]
colnames(CN.cont)<-c("Type", "C.N", "SD", "n")



#### controls d15N
iso.plot.control.d15N<-ggplot(data=topes.controls,  aes(x=Type, y=d15N, fill=Type)) +
  geom_boxplot() +
  geom_point(pch = 21, position = position_jitterdodge(), alpha=0.6)+
  ylab(expression(paste(delta^{15}, N, " (\u2030, air)"))) +
  scale_fill_manual(values = c("azure2", "cornflowerblue",
                                "darkgoldenrod1", "darkgoldenrod",
                                "darkseagreen3", "darkolivegreen3",
                                "darkolivegreen4", "darkgreen")) +
  xlab("control types") +  Fig.formatting +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


###### control C:N
topes.controls.CN<-topes.controls %>% drop_na(C.N) # drop the NAs for C.N, makes plotting problematic

iso.plot.control.CN<-ggplot(data=topes.controls.CN,  aes(x=Type, y=C.N, fill=Type)) +
  geom_boxplot() +
  geom_point(pch = 21, position = position_jitterdodge(), alpha=0.6)+
  ylab("C:N") +
  scale_fill_manual(values = c("cornflowerblue",
                                "darkgoldenrod1", "darkgoldenrod",
                                "darkseagreen3", "darkolivegreen3",
                                "darkolivegreen4", "darkgreen")) +
  xlab("control types") +  Fig.formatting +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


####### combine plots
# legend
extract.legend.cont <- get_legend(
  # create some space to the left of the legend
  iso.plot.control.d15N + theme(legend.box.margin = margin(0, 0, 0, 10)))


## combine 
control.iso.alltime<- plot_grid(iso.plot.control.d15N + theme(legend.position = "none"), 
                    iso.plot.control.CN + theme(legend.position = "none"),
                    extract.legend.cont, rel_widths = c(8,8,3), ncol=3)

ggsave("figures/iso.controls.pdf", encod="MacRoman", height=5, width=10)


######## alternative figure
d15N.plot<-plot_grid(iso.plot.control.d15N + theme(axis.text.x = element_blank()), 
                     isotope.plots, rel_widths = c(11,16), ncol=2)
ggsave("figures/iso.d15.control.trt.pdf", encod="MacRoman", height=5, width=13)
```

Use a mixing model to calculate % sage
```{r percent sage}
# mixing model
head(topes.trt)
topes.trt<-droplevels(topes.trt)


### values for controls
d15N.cont # summary mean d15N by all controls
d15N.plant # summary by plants, # sage 296, #  willow 13

# summary mean atom percent enrichment
F.cont<-aggregate(at.P..15N  ~ Type, topes.controls, mean)
F.plant<-aggregate(at.P..15N~Plant, topes.controls, FUN=mean)
# sage ~0.475
# willow 0.371

# 2 source mixing model (Post 2002)

# alpha = percent Sage from food web 1
# %Sage = (d15N sample - d15N base 2 [i.e., no-label food])/ (d15N sage food 1 - source 2)
#  d15N values of base 2 = 11 permil for algae/plankton stock/willow
#  d15N value of base 1 = 298 permil for sage

topes.trt$percent.sage<-(topes.trt$d15N-12)/(296-12)


# unicode text for micrometer = \u03BC, use this in legend

iso.mix.T1<-ggplot(topes.trt[(topes.trt$Time.point=="T1"),], aes(x=plant.mass..g, y=100*percent.sage, color=Treatment)) +
  geom_point(aes(shape=Type)) +
  scale_shape_manual(name="Plankton", values = c(17, 16), 
                     labels = c(expression(paste("> 63"~mu,"m")), 
                                expression(paste("< 63"~mu,"m")))) +
  scale_color_manual(name="Treatments", values = c("brown1", "mediumseagreen")) +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "tp", k = 5),
              aes(fill=Treatment), alpha=0.1, show.legend = FALSE) +
  ylab("% Sage")+
  xlab("plant material (g)") +
  ggtitle("Time-1") +
  coord_cartesian(ylim=c(0, 100)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))


######################

iso.mix.T2<-ggplot(topes.trt[(topes.trt$Time.point=="T2"),], aes(x=plant.mass..g, y=100*percent.sage, color=Treatment)) +
  geom_point(aes(shape=Type)) +
  scale_shape_manual(name="Plankton", values = c(17, 16), 
                     labels = c(expression(paste("> 63"~mu,"m")), 
                                expression(paste("< 63"~mu,"m")))) +
  scale_color_manual(name="Treatments", values = c("brown1", "mediumseagreen")) +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "tp", k = 5),
              aes(fill=Treatment), alpha=0.1, show.legend = FALSE) +
  ylab("% Sage")+
  xlab("plant material (g)") +
  ggtitle("Time-2") +
  coord_cartesian(ylim=c(0, 100)) +
  Fig.formatting +
  theme(legend.key.size = unit(1,"line"))


# legend
extract.legend.mix <- get_legend(
  # create some space to the left of the legend
  iso.mix.T2 + theme(legend.box.margin = margin(0, 0, 0, 10)))


## combine 
control.iso.alltime<- plot_grid(iso.mix.T1 + theme(legend.position = "none"), 
                    iso.mix.T2 + theme(legend.position = "none"),
                    extract.legend.mix, rel_widths = c(8,8,3), ncol=3)

ggsave("figures/Isotope.mixmodel.pdf", encod="MacRoman", height=5, width=10)
```

model for % sage
```{r percent sage models}
############# all plankton T1
m1a.T1.sage <- gam(percent.sage ~ Treatment*Type +
            s(plant.mass..g, by=Treatment), 
            subset = Time.point=="T1", data=topes.trt, method="REML", family="gaussian")

m1b.T1.sage <- gam(percent.sage ~ Treatment + Type +
            s(plant.mass..g, by=Treatment), 
            subset = Time.point=="T1", data=topes.trt, method="REML", family="gaussian")

AIC(m1a.T1.sage, m1b.T1.sage)
## additive model best fit

summary(m1b.T1.sage)
anova.gam(m1b.T1.sage)
gam.check(m1b.T1.sage, rep=1000)
draw(m1b.T1.sage)
concrvity(m1b.T1.sage)
par(mfrow = c(1, 2))
plot(m1b.T1.sage, all.terms = TRUE, page=1)

# overall an effect of burning with both smoothers being significant by treatment
# no effect of type, POM and plankton with similar d15N values


############# all plankton T2
m1a.T2.sage <- gam(percent.sage ~ Treatment*Type +
            s(plant.mass..g, by=Treatment), 
            subset = Time.point=="T2", data=topes.trt, method="REML", family="gaussian")

m1b.T2.sage <- gam(percent.sage ~ Treatment + Type +
            s(plant.mass..g, by=Treatment), 
            subset = Time.point=="T2", data=topes.trt, method="REML", family="gaussian")



AIC(m1a.T2.sage, m1b.T2.sage) 
# m1b.T2.sage preferred
# compare across

summary(m1b.T2.sage)
anova.gam(m1b.T2.sage)
gam.check(m1b.T2.sage, rep=1000)
draw(m1b.T2.sage)
concrvity(m1b.T2.sage)
par(mfrow = c(1, 2))
plot(m1b.T2.sage, all.terms = TRUE, page=1)

# effect of treatment (p<0.001) but not Type (p=0.321)
# smoother significant for both terms

```



